class Model3DViewer{constructor(){this.loadedFiles=[],this.currentFileIndex=-1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.currentModel=null,this.gridHelper=null,this.axesHelper=null,this.wireframeMode=!1,this.isDarkTheme=!1,this.autoRotate=!1,this.targetCameraPosition=new THREE.Vector3,this.currentCameraPosition=new THREE.Vector3,this.isTransitioning=!1,this.modelStats={vertices:0,faces:0,volume:0,surfaceArea:0,boundingBox:{min:null,max:null}},this.init(),this.setupTheme(),this.setupEventListeners(),this.showWelcomeMessage(!0)}init(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(16316922);const e=document.getElementById("canvas"),t=e.clientWidth/e.clientHeight;this.camera=new THREE.PerspectiveCamera(75,t,.1,1e3),this.camera.position.set(5,5,5),this.renderer=new THREE.WebGLRenderer({canvas:e,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=1,this.controls.maxDistance=100,this.setupLighting(),this.setupGridAndAxes(),this.animate(),this.handleResize()}setupLighting(){const e=new THREE.AmbientLight(4210752,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,10,5),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,this.scene.add(t);const i=new THREE.PointLight(16777215,.5);i.position.set(-10,-10,-5),this.scene.add(i)}setupGridAndAxes(){this.gridHelper=new THREE.GridHelper(20,20,8947848,13421772),this.scene.add(this.gridHelper),this.axesHelper=new THREE.AxesHelper(5),this.axesHelper.visible=!1,this.scene.add(this.axesHelper)}setupTheme(){const e=localStorage.getItem("theme")||"light";this.isDarkTheme="dark"===e,this.applyTheme()}toggleTheme(){this.isDarkTheme=!this.isDarkTheme,localStorage.setItem("theme",this.isDarkTheme?"dark":"light"),this.applyTheme()}applyTheme(){const e=document.getElementById("themeToggle").querySelector("i");this.isDarkTheme?(document.documentElement.setAttribute("data-theme","dark"),e.className="fas fa-sun",this.scene.background=new THREE.Color(1710618),this.currentModel&&this.currentModel.material.color.set(8305407)):(document.documentElement.removeAttribute("data-theme"),e.className="fas fa-moon",this.scene.background=new THREE.Color(16316922),this.currentModel&&this.currentModel.material.color.set(2132223))}handleFileUpload(e){0!==e.length&&(this.showLoading(!0),this.showWelcomeMessage(!1),Array.from(e).forEach((e=>{const t=e.name.toLowerCase();this.loadedFiles.some((t=>t.file.name===e.name))||(t.endsWith(".stl")?this.loadSTL(e):t.endsWith(".obj")?this.loadOBJ(e):alert(`Unsupported file format: ${e.name}`))})))}loadSTL(e){const t=new FileReader;t.onload=t=>{try{const i=(new THREE.STLLoader).parse(t.target.result);this.createModelFromGeometry(i),this.loadedFiles.push({file:e,geometry:i,type:"stl"}),this.currentFileIndex=this.loadedFiles.length-1}catch(t){alert(`Error loading STL file: ${e.name}`)}},t.readAsArrayBuffer(e)}loadOBJ(e){const t=new FileReader;t.onload=t=>{try{const i=(new THREE.OBJLoader).parse(t.target.result);let s;if(i.children.length>0){const e=[];i.traverse((t=>{t.isMesh&&(t.geometry.computeBoundingBox(),e.push(t.geometry))})),e.length>0&&(s=e[0])}else s=i.geometry;s&&(this.createModelFromGeometry(s),this.loadedFiles.push({file:e,geometry:s,type:"obj"}),this.currentFileIndex=this.loadedFiles.length-1)}catch(t){alert(`Error loading OBJ file: ${e.name}`)}},t.readAsText(e)}createModelFromGeometry(e,t){this.currentModel&&this.scene.remove(this.currentModel),e.computeBoundingBox();const i=e.boundingBox,s=new THREE.Vector3;i.getCenter(s),e.translate(-s.x,-s.y,-s.z);const n=new THREE.MeshPhongMaterial({color:this.isDarkTheme?8305407:2132223,specular:1118481,shininess:100,side:THREE.DoubleSide});if(this.currentModel=new THREE.Mesh(e,n),this.currentModel.castShadow=!0,this.currentModel.receiveShadow=!0,this.scene.add(this.currentModel),this.calculateModelStats(e),this.updateStatsDisplay(),t){const e=this.loadedFiles.findIndex((e=>e.file.name===t));-1!==e&&(this.currentFileIndex=e)}setTimeout((()=>{this.resetCameraView(),this.updateFileList(),this.showLoading(!1)}),200)}calculateModelStats(e){const t=e.attributes.position,i=e.index;this.modelStats.vertices=t.count,this.modelStats.faces=i?i.count/3:t.count/3,e.computeBoundingBox(),this.modelStats.boundingBox=e.boundingBox,this.calculateSurfaceAreaAndVolume(e)}calculateSurfaceAreaAndVolume(e){const t=e.attributes.position,i=e.index;let s=0,n=0;if(i)for(let e=0;e<i.count;e+=3){const o=i.getX(e),a=i.getX(e+1),r=i.getX(e+2),l=new THREE.Vector3(t.getX(o),t.getY(o),t.getZ(o)),d=new THREE.Vector3(t.getX(a),t.getY(a),t.getZ(a)),c=new THREE.Vector3(t.getX(r),t.getY(r),t.getZ(r));s+=this.calculateTriangleArea(l,d,c),n+=this.calculateSignedVolume(l,d,c)}else for(let e=0;e<t.count;e+=9){const i=new THREE.Vector3(t.getX(e),t.getY(e),t.getZ(e)),o=new THREE.Vector3(t.getX(e+3),t.getY(e+3),t.getZ(e+3)),a=new THREE.Vector3(t.getX(e+6),t.getY(e+6),t.getZ(e+6));s+=this.calculateTriangleArea(i,o,a),n+=this.calculateSignedVolume(i,o,a)}this.modelStats.surfaceArea=s,this.modelStats.volume=Math.abs(n)}calculateTriangleArea(e,t,i){const s=(new THREE.Vector3).subVectors(t,e),n=(new THREE.Vector3).subVectors(i,e);return.5*(new THREE.Vector3).crossVectors(s,n).length()}calculateSignedVolume(e,t,i){return e.dot(t.cross(i))/6}updateStatsDisplay(){document.getElementById("vertexCount").textContent=this.modelStats.vertices.toLocaleString(),document.getElementById("faceCount").textContent=Math.floor(this.modelStats.faces).toLocaleString(),document.getElementById("volume").textContent=this.modelStats.volume.toFixed(2)+" units³",document.getElementById("surfaceArea").textContent=this.modelStats.surfaceArea.toFixed(2)+" units²";const e=this.modelStats.boundingBox;if(e&&e.min&&e.max){const t=new THREE.Vector3;e.getSize(t),document.getElementById("boundingBox").textContent=`${t.x.toFixed(2)} × ${t.y.toFixed(2)} × ${t.z.toFixed(2)}`}}fitCameraToModel(e){e.computeBoundingBox();const t=e.boundingBox,i=new THREE.Vector3;t.getSize(i);const s=Math.max(i.x,i.y,i.z),n=this.camera.fov*(Math.PI/180);let o=Math.abs(s/2/Math.tan(n/2));o*=2.5,this.camera.position.set(o,o,o),this.camera.lookAt(0,0,0),this.controls.target.set(0,0,0),this.controls.update()}setCameraViewSmooth(e){if(!this.currentModel||this.isTransitioning)return;this.isTransitioning=!0;const t=this.camera.position.length();let i=new THREE.Vector3;switch(e){case"top":i.set(0,t,0);break;case"bottom":i.set(0,-t,0);break;case"front":i.set(0,0,t);break;case"back":i.set(0,0,-t);break;case"left":i.set(-t,0,0);break;case"right":i.set(t,0,0);break;default:return void this.resetCameraView()}this.animateCameraToPosition(i)}animateCameraToPosition(e){const t=this.camera.position.clone(),i=this.controls.target.clone(),s=Date.now(),n=()=>{const o=Date.now()-s,a=Math.min(o/1e3,1),r=1-Math.pow(1-a,3);this.camera.position.lerpVectors(t,e,r),this.controls.target.lerpVectors(i,new THREE.Vector3(0,0,0),r),this.controls.update(),a<1?requestAnimationFrame(n):this.isTransitioning=!1};n()}resetCameraView(){this.isTransitioning=!1,this.currentModel&&(document.getElementById("viewSelect").value="default",this.fitCameraToModel(this.currentModel.geometry))}toggleWireframe(){this.wireframeMode=!this.wireframeMode,this.currentModel&&(this.currentModel.material.wireframe=this.wireframeMode);const e=document.getElementById("toggleWireframe");this.wireframeMode?e.classList.add("active"):e.classList.remove("active")}toggleGrid(){if(this.gridHelper){this.gridHelper.visible=!this.gridHelper.visible;const e=document.getElementById("toggleGrid");this.gridHelper.visible?e.classList.add("active"):e.classList.remove("active")}}toggleAxes(){if(this.axesHelper){this.axesHelper.visible=!this.axesHelper.visible;const e=document.getElementById("toggleAxes");this.axesHelper.visible?e.classList.add("active"):e.classList.remove("active")}}toggleAutoRotate(){this.autoRotate=!this.autoRotate,this.controls.autoRotate=this.autoRotate;const e=document.getElementById("toggleAutoRotate"),t=e.querySelector("i");this.autoRotate?(e.classList.add("active"),t.classList.add("rotating"),this.controls.autoRotateSpeed=2):(e.classList.remove("active"),t.classList.remove("rotating"),this.controls.autoRotateSpeed=0)}exportImage(e){if(!this.currentModel)return void alert("No model loaded to export");this.renderer.render(this.scene,this.camera);const t=this.renderer.domElement,i=document.createElement("a");i.download=`3d-model-${Date.now()}.${e}`,"png"===e?i.href=t.toDataURL("image/png"):"jpeg"===e&&(i.href=t.toDataURL("image/jpeg",.9)),document.body.appendChild(i),i.click(),document.body.removeChild(i)}removeFile(e){const t=this.loadedFiles.findIndex((t=>t.file.name===e));if(-1!==t){this.loadedFiles.splice(t,1);if(document.getElementById("fileList").innerHTML="",this.loadedFiles.length>0)if(t===this.currentFileIndex){if(this.currentFileIndex=Math.max(0,t-1),this.loadedFiles.length>0){const e=this.loadedFiles[this.currentFileIndex];this.createModelFromGeometry(e.geometry,e.file.name)}}else t<this.currentFileIndex&&this.currentFileIndex--,this.updateFileList();else this.clearViewer(),this.updateFileList()}0===this.loadedFiles.length&&(document.getElementById("fileInput").value="")}clearViewer(){this.currentModel&&(this.scene.remove(this.currentModel),this.currentModel=null),this.modelStats={vertices:0,faces:0,volume:0,surfaceArea:0,boundingBox:{min:null,max:null}},this.updateStatsDisplay(),this.showWelcomeMessage(!0),document.getElementById("fileList").innerHTML=""}updateFileList(){const e=document.getElementById("fileList");e.innerHTML="",this.loadedFiles.forEach(((t,i)=>{const s=document.createElement("div");s.classList.add("file-item"),i==this.currentFileIndex&&s.classList.add("active"),s.innerHTML=`\n                <button class="file-name" data-idx="${i}">${t.file.name}</button>\n                <button class="remove-file" data-name="${t.file.name}">\n                    <i class="fas fa-trash"></i>\n                </button>\n            `,e.appendChild(s)})),e.querySelectorAll(".file-name").forEach((e=>{e.addEventListener("click",(e=>{const t=parseInt(e.target.dataset.idx,10);this.loadedFiles[t]&&this.createModelFromGeometry(this.loadedFiles[t].geometry,this.loadedFiles[t].file.name)}))})),e.querySelectorAll(".remove-file").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.name;this.removeFile(t)}))}))}setupEventListeners(){document.getElementById("fileInput").addEventListener("change",(e=>{this.handleFileUpload(e.target.files)})),document.getElementById("viewSelect").addEventListener("change",(e=>{this.setCameraViewSmooth(e.target.value)})),document.getElementById("exportPNG").addEventListener("click",(()=>{this.exportImage("png")})),document.getElementById("exportJPEG").addEventListener("click",(()=>{this.exportImage("jpeg")})),document.getElementById("resetView").addEventListener("click",(()=>{this.resetCameraView()})),document.getElementById("toggleGrid").addEventListener("click",(()=>{this.toggleGrid()})),document.getElementById("toggleWireframe").addEventListener("click",(()=>{this.toggleWireframe()})),document.getElementById("toggleAxes").addEventListener("click",(()=>{this.toggleAxes()})),document.getElementById("toggleAutoRotate").addEventListener("click",(()=>{this.toggleAutoRotate()})),document.getElementById("themeToggle").addEventListener("click",(()=>{this.toggleTheme()})),window.addEventListener("resize",(()=>this.handleResize()))}handleResize(){const e=document.getElementById("canvas"),t=e.clientWidth,i=e.clientHeight;this.camera.aspect=t/i,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,i)}animate(){requestAnimationFrame((()=>this.animate())),this.controls&&this.controls.update(),this.renderer.render(this.scene,this.camera)}showLoading(e){const t=document.getElementById("loadingIndicator"),i=document.getElementById("welcomeMessage");e?(t.classList.remove("hidden"),i.classList.add("hidden")):(t.classList.add("hidden"),i.classList.add("hidden"))}showWelcomeMessage(e){const t=document.getElementById("welcomeMessage"),i=document.getElementById("controlButtons"),s=document.getElementById("canvas");e?(t.classList.remove("hidden"),i.classList.add("hidden"),s.style.visibility="hidden"):(t.classList.add("hidden"),i.classList.remove("hidden"),s.style.visibility="visible")}}document.addEventListener("DOMContentLoaded",(()=>new Model3DViewer));