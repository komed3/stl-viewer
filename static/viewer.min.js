class Model3DViewer{constructor(){this.loadedFiles=[],this.currentFileIndex=-1,this.scene=null,this.camera=null,this.renderer=null,this.controls=null,this.currentModel=null,this.gridHelper=null,this.axesHelper=null,this.wireframeMode=!1,this.isDarkTheme=!1,this.autoRotate=!1,this.targetCameraPosition=new THREE.Vector3,this.currentCameraPosition=new THREE.Vector3,this.isTransitioning=!1,this.modelStats={vertices:0,faces:0,volume:0,surfaceArea:0,boundingBox:{min:null,max:null}},this.init(),this.setupTheme(),this.setupEventListeners(),this.showWelcomeMessage(!0)}init(){this.scene=new THREE.Scene,this.scene.background=new THREE.Color(16316922);const e=document.getElementById("canvas"),t=e.clientWidth/e.clientHeight;this.camera=new THREE.PerspectiveCamera(75,t,.1,1e3),this.camera.position.set(5,5,5),this.renderer=new THREE.WebGLRenderer({canvas:e,antialias:!0,preserveDrawingBuffer:!0}),this.renderer.setSize(e.clientWidth,e.clientHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.screenSpacePanning=!1,this.controls.minDistance=1,this.controls.maxDistance=100,this.setupLighting(),this.setupGridAndAxes(),this.animate(),this.handleResize()}setupLighting(){const e=new THREE.AmbientLight(4210752,.6);this.scene.add(e);const t=new THREE.DirectionalLight(16777215,.8);t.position.set(10,10,5),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,this.scene.add(t);const s=new THREE.PointLight(16777215,.5);s.position.set(-10,-10,-5),this.scene.add(s)}setupGridAndAxes(){this.gridHelper=new THREE.GridHelper(20,20,8947848,13421772),this.scene.add(this.gridHelper),this.axesHelper=new THREE.AxesHelper(5),this.axesHelper.visible=!1,this.scene.add(this.axesHelper)}setupTheme(){const e=localStorage.getItem("theme")||"light";this.isDarkTheme="dark"===e,this.applyTheme()}toggleTheme(){this.isDarkTheme=!this.isDarkTheme,localStorage.setItem("theme",this.isDarkTheme?"dark":"light"),this.applyTheme()}applyTheme(){const e=document.getElementById("themeToggle").querySelector("i");this.isDarkTheme?(document.documentElement.setAttribute("data-theme","dark"),this.scene.background=new THREE.Color(1710618),e.className="fas fa-sun"):(document.documentElement.removeAttribute("data-theme"),this.scene.background=new THREE.Color(16316922),e.className="fas fa-moon")}handleFileUpload(e){0!==e.length&&(this.showLoading(!0),this.showWelcomeMessage(!1),this.loadedFiles=[],this.currentFileIndex=-1,Array.from(e).forEach((e=>{const t=e.name.toLowerCase();t.endsWith(".stl")?this.loadSTL(e):t.endsWith(".obj")?this.loadOBJ(e):alert(`Unsupported file format: ${e.name}`)})),this.updateFileList(e))}loadSTL(e){const t=new FileReader;t.onload=t=>{try{const s=(new THREE.STLLoader).parse(t.target.result);this.createModelFromGeometry(s),this.loadedFiles.push({file:e,geometry:s,type:"stl"}),this.currentFileIndex=this.loadedFiles.length-1}catch(t){alert(`Error loading STL file: ${e.name}`)}},t.readAsArrayBuffer(e)}loadOBJ(e){const t=new FileReader;t.onload=t=>{try{const s=(new THREE.OBJLoader).parse(t.target.result);let i;if(s.children.length>0){const e=[];s.traverse((t=>{t.isMesh&&(t.geometry.computeBoundingBox(),e.push(t.geometry))})),e.length>0&&(i=e[0])}else i=s.geometry;i&&(this.createModelFromGeometry(i),this.loadedFiles.push({file:e,geometry:i,type:"obj"}),this.currentFileIndex=this.loadedFiles.length-1)}catch(t){alert(`Error loading OBJ file: ${e.name}`)}},t.readAsText(e)}createModelFromGeometry(e){this.currentModel&&this.scene.remove(this.currentModel),e.computeBoundingBox();const t=e.boundingBox,s=new THREE.Vector3;t.getCenter(s),e.translate(-s.x,-s.y,-s.z);const i=new THREE.MeshPhongMaterial({color:4890367,specular:1118481,shininess:100,side:THREE.DoubleSide});this.currentModel=new THREE.Mesh(e,i),this.currentModel.castShadow=!0,this.currentModel.receiveShadow=!0,this.scene.add(this.currentModel),this.calculateModelStats(e),this.updateStatsDisplay(),this.fitCameraToModel(e),this.showLoading(!1)}calculateModelStats(e){const t=e.attributes.position,s=e.index;this.modelStats.vertices=t.count,this.modelStats.faces=s?s.count/3:t.count/3,e.computeBoundingBox(),this.modelStats.boundingBox=e.boundingBox,this.calculateSurfaceAreaAndVolume(e)}calculateSurfaceAreaAndVolume(e){const t=e.attributes.position,s=e.index;let i=0,n=0;if(s)for(let e=0;e<s.count;e+=3){const o=s.getX(e),a=s.getX(e+1),r=s.getX(e+2),l=new THREE.Vector3(t.getX(o),t.getY(o),t.getZ(o)),d=new THREE.Vector3(t.getX(a),t.getY(a),t.getZ(a)),c=new THREE.Vector3(t.getX(r),t.getY(r),t.getZ(r));i+=this.calculateTriangleArea(l,d,c),n+=this.calculateSignedVolume(l,d,c)}else for(let e=0;e<t.count;e+=9){const s=new THREE.Vector3(t.getX(e),t.getY(e),t.getZ(e)),o=new THREE.Vector3(t.getX(e+3),t.getY(e+3),t.getZ(e+3)),a=new THREE.Vector3(t.getX(e+6),t.getY(e+6),t.getZ(e+6));i+=this.calculateTriangleArea(s,o,a),n+=this.calculateSignedVolume(s,o,a)}this.modelStats.surfaceArea=i,this.modelStats.volume=Math.abs(n)}calculateTriangleArea(e,t,s){const i=(new THREE.Vector3).subVectors(t,e),n=(new THREE.Vector3).subVectors(s,e);return.5*(new THREE.Vector3).crossVectors(i,n).length()}calculateSignedVolume(e,t,s){return e.dot(t.cross(s))/6}updateStatsDisplay(){document.getElementById("vertexCount").textContent=this.modelStats.vertices.toLocaleString(),document.getElementById("faceCount").textContent=Math.floor(this.modelStats.faces).toLocaleString(),document.getElementById("volume").textContent=this.modelStats.volume.toFixed(2)+" units³",document.getElementById("surfaceArea").textContent=this.modelStats.surfaceArea.toFixed(2)+" units²";const e=this.modelStats.boundingBox;if(e&&e.min&&e.max){const t=new THREE.Vector3;e.getSize(t),document.getElementById("boundingBox").textContent=`${t.x.toFixed(2)} × ${t.y.toFixed(2)} × ${t.z.toFixed(2)}`}}fitCameraToModel(e){e.computeBoundingBox();const t=e.boundingBox,s=new THREE.Vector3;t.getSize(s);const i=Math.max(s.x,s.y,s.z),n=this.camera.fov*(Math.PI/180);let o=Math.abs(i/2/Math.tan(n/2));o*=2.5,this.camera.position.set(o,o,o),this.camera.lookAt(0,0,0),this.controls.target.set(0,0,0),this.controls.update()}setCameraViewSmooth(e){if(!this.currentModel||this.isTransitioning)return;this.isTransitioning=!0;const t=this.camera.position.length();let s=new THREE.Vector3;switch(e){case"top":s.set(0,t,0);break;case"bottom":s.set(0,-t,0);break;case"front":s.set(0,0,t);break;case"back":s.set(0,0,-t);break;case"left":s.set(-t,0,0);break;case"right":s.set(t,0,0);break;default:return void this.resetCameraView()}this.animateCameraToPosition(s)}animateCameraToPosition(e){const t=this.camera.position.clone(),s=this.controls.target.clone(),i=Date.now(),n=()=>{const o=Date.now()-i,a=Math.min(o/1e3,1),r=1-Math.pow(1-a,3);this.camera.position.lerpVectors(t,e,r),this.controls.target.lerpVectors(s,new THREE.Vector3(0,0,0),r),this.controls.update(),a<1?requestAnimationFrame(n):this.isTransitioning=!1};n()}resetCameraView(){this.currentModel&&this.fitCameraToModel(this.currentModel.geometry)}toggleWireframe(){this.wireframeMode=!this.wireframeMode,this.currentModel&&(this.currentModel.material.wireframe=this.wireframeMode);const e=document.getElementById("toggleWireframe");this.wireframeMode?e.classList.add("active"):e.classList.remove("active")}toggleGrid(){if(this.gridHelper){this.gridHelper.visible=!this.gridHelper.visible;const e=document.getElementById("toggleGrid");this.gridHelper.visible?e.classList.add("active"):e.classList.remove("active")}}toggleAxes(){if(this.axesHelper){this.axesHelper.visible=!this.axesHelper.visible;const e=document.getElementById("toggleAxes");this.axesHelper.visible?e.classList.add("active"):e.classList.remove("active")}}toggleAutoRotate(){this.autoRotate=!this.autoRotate,this.controls.autoRotate=this.autoRotate;const e=document.getElementById("toggleAutoRotate"),t=e.querySelector("i");this.autoRotate?(e.classList.add("active"),t.classList.add("rotating"),this.controls.autoRotateSpeed=2):(e.classList.remove("active"),t.classList.remove("rotating"),this.controls.autoRotateSpeed=0)}exportImage(e){if(!this.currentModel)return void alert("No model loaded to export");this.renderer.render(this.scene,this.camera);const t=this.renderer.domElement,s=document.createElement("a");s.download=`3d-model-${Date.now()}.${e}`,"png"===e?s.href=t.toDataURL("image/png"):"jpeg"===e&&(s.href=t.toDataURL("image/jpeg",.9)),document.body.appendChild(s),s.click(),document.body.removeChild(s)}removeFile(e){const t=this.loadedFiles.findIndex((t=>t.file.name===e));if(-1!==t){this.loadedFiles.splice(t,1);if(document.getElementById("fileList").innerHTML="",this.loadedFiles.length>0){if(this.updateFileList(this.loadedFiles.map((e=>e.file))),t===this.currentFileIndex&&(this.currentFileIndex=Math.max(0,t-1),this.loadedFiles.length>0)){const e=this.loadedFiles[this.currentFileIndex];this.createModelFromGeometry(e.geometry,e.file.name)}}else this.clearViewer()}0===this.loadedFiles.length&&(document.getElementById("fileInput").value="")}clearViewer(){this.currentModel&&(this.scene.remove(this.currentModel),this.currentModel=null),this.modelStats={vertices:0,faces:0,volume:0,surfaceArea:0,boundingBox:{min:null,max:null}},this.updateStatsDisplay(),this.showWelcomeMessage(!0),document.getElementById("fileList").innerHTML=""}updateFileList(e){const t=document.getElementById("fileList");t.innerHTML="",Array.from(e).forEach((e=>{const s=document.createElement("div");s.className="file-item",s.innerHTML=`\n                <span class="file-name">${e.name}</span>\n                <button class="remove-file" data-name="${e.name}">\n                    <i class="fas fa-trash"></i>\n                </button>\n            `,t.appendChild(s)})),t.addEventListener("click",(e=>{if(e.target.classList.contains("remove-file")||e.target.parentElement.classList.contains("remove-file")){const t=e.target.dataset?.name||e.target.parentElement.dataset.name;this.removeFile(t)}}))}setupEventListeners(){document.getElementById("fileInput").addEventListener("change",(e=>{this.handleFileUpload(e.target.files)})),document.getElementById("viewSelect").addEventListener("change",(e=>{this.setCameraViewSmooth(e.target.value)})),document.getElementById("exportPNG").addEventListener("click",(()=>{this.exportImage("png")})),document.getElementById("exportJPEG").addEventListener("click",(()=>{this.exportImage("jpeg")})),document.getElementById("resetView").addEventListener("click",(()=>{this.resetCameraView()})),document.getElementById("toggleGrid").addEventListener("click",(()=>{this.toggleGrid()})),document.getElementById("toggleWireframe").addEventListener("click",(()=>{this.toggleWireframe()})),document.getElementById("toggleAxes").addEventListener("click",(()=>{this.toggleAxes()})),document.getElementById("toggleAutoRotate").addEventListener("click",(()=>{this.toggleAutoRotate()})),document.getElementById("themeToggle").addEventListener("click",(()=>{this.toggleTheme()})),window.addEventListener("resize",(()=>this.handleResize()))}handleResize(){const e=document.getElementById("canvas"),t=e.clientWidth,s=e.clientHeight;this.camera.aspect=t/s,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,s)}animate(){requestAnimationFrame((()=>this.animate())),this.controls&&this.controls.update(),this.renderer.render(this.scene,this.camera)}showLoading(e){const t=document.getElementById("loadingIndicator"),s=document.getElementById("welcomeMessage");e?(t.classList.remove("hidden"),s.classList.add("hidden")):(t.classList.add("hidden"),s.classList.add("hidden"))}showWelcomeMessage(e){const t=document.getElementById("welcomeMessage"),s=document.getElementById("controlButtons"),i=document.getElementById("canvas");e?(t.classList.remove("hidden"),s.classList.add("hidden"),i.style.visibility="hidden"):(t.classList.add("hidden"),s.classList.remove("hidden"),i.style.visibility="visible")}}document.addEventListener("DOMContentLoaded",(()=>new Model3DViewer));